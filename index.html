<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Year-End Party Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="style.css">

    <!-- Import Map for Vue -->
    <script type="importmap">
        {
            "imports": {
                "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
            }
        }
    </script>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- tsParticles -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
</head>

<body>
    <!-- Background Particles -->
    <div id="tsparticles"></div>

    <!-- Main App -->
    <div id="app" v-cloak>
        <div class="update-indicator">
            <div class="update-group">
                <div class="update-label">最後更新</div>
                <div class="update-time">{{ lastUpdateTime }}</div>
            </div>
            <div class="update-divider"></div>
            <div class="update-group">
                <div class="update-label">下次更新</div>
                <div class="update-next-time">{{ secondsUntilNext }}<span class="unit">秒</span></div>
            </div>
        </div>
        <div class="dashboard-grid">

            <!-- Left Panel: Access Log -->
            <section class="panel left-panel">
                <div class="panel-header">
                    <h2>ACCESS LOG</h2>
                    <div class="decor-line"></div>
                </div>
                <div class="log-list">
                    <transition-group name="list-slide-down" tag="ul">
                        <li v-for="log in accessLog" :key="log.id" class="log-item">
                            <span class="timestamp">[{{ log.time }}]</span>
                            <span class="dept">{{ log.dept }}</span>
                            <span class="name">{{ log.name }}</span>
                        </li>
                    </transition-group>
                </div>
                <!-- Decorative Corners -->
                <div class="corner top-left"></div>
                <div class="corner top-right"></div>
                <div class="corner bottom-left"></div>
                <div class="corner bottom-right"></div>
            </section>

            <!-- Center Panel: Radar System -->
            <section class="panel center-panel">
                <div class="radar-container">
                    <div class="radar-circle" :class="{ pulse: isPulsing }">
                        <div class="radar-scan"></div>
                        <div class="radar-content">
                            <div class="label">CREW ONBOARD</div>
                            <div class="count" ref="countRef">{{ animatedCount }}</div>
                            <div class="attendance-ratio">
                                <span class="current">{{ totalCount }}</span>
                                <span class="divider">/</span>
                                <span class="total">{{ roster.length }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Right Panel: Comm Channel -->
            <section class="panel right-panel">
                <div class="panel-header">
                    <h2>INCOMING MESSAGES</h2>
                    <div class="decor-line"></div>
                </div>
                <div class="wish-list">
                    <transition-group name="list-slide-up" tag="div" class="wish-stack">
                        <div v-for="(wish, index) in wishStack" :key="wish.id" class="wish-card">
                            <div class="wish-header">
                                <span class="wish-from">{{ wish.title }}</span>
                            </div>
                            <div class="wish-body">
                                <typewriter :text="wish.message" :show-cursor="index === 0"></typewriter>
                            </div>
                        </div>
                    </transition-group>
                </div>
                <!-- Decorative Corners -->
                <div class="corner top-left"></div>
                <div class="corner top-right"></div>
                <div class="corner bottom-left"></div>
                <div class="corner bottom-right"></div>
            </section>

        </div>
        <!-- Admin Roster Modal -->
        <div v-if="showAdminModal" class="admin-modal-overlay">
            <div class="admin-modal">
                <div class="admin-header">
                    <div class="header-left">
                        <h2>ADMIN ROSTER STATUS</h2>
                        <div class="admin-stats">
                            <span class="stat-item missing">MISSING: {{ missingCount }}</span>
                            <span class="stat-separator">/</span>
                            <span class="stat-item total">TOTAL: {{ roster.length }}</span>
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="sort-controls">
                            <button class="sort-btn" :class="{ active: sortBy === 'dept' }"
                                @click="sortBy = 'dept'">DEPT</button>
                            <button class="sort-btn" :class="{ active: sortBy === 'id' }"
                                @click="sortBy = 'id'">ID</button>
                        </div>
                        <button class="export-btn" @click="exportCSV">EXPORT CSV</button>
                        <input type="text" v-model="searchTerm" placeholder="Search Name/ID/Dept..."
                            class="admin-search">
                        <button class="close-btn" @click="closeAdminModal">X</button>
                    </div>
                </div>
                <div class="roster-grid">
                    <div v-for="emp in filteredRoster" :key="emp.id" class="roster-card"
                        :class="{ 'arrived': processedIds.has(String(emp.id)), 'missing': !processedIds.has(String(emp.id)) }">
                        <div class="card-left">
                            <span class="roster-id">{{ emp.id }}</span>
                            <span class="roster-name">{{ emp.name }}</span>
                        </div>
                        <div class="card-right">
                            <span class="roster-dept">{{ emp.dept }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- App Logic -->
    <script type="module" src="app.js"></script>
</body>

</html>